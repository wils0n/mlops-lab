# ğŸ› ï¸ Monitoreo de FastAPI con Prometheus y Grafana

## ğŸ¯ Objetivo

Instrumentar una API en **FastAPI** para recolectar mÃ©tricas con **Prometheus** y visualizarlas en **Grafana**.

---

## ğŸ§© Estructura del entorno

```
mlops-lab/
â”œâ”€â”€ docker-compose.yml
â”œâ”€â”€ prometheus/
â”‚   â””â”€â”€ prometheus.yml
â”œâ”€â”€ app/
â”‚   â””â”€â”€ main.py
â”‚   â””â”€â”€ requirements.txt
```

---

## âœ… 1. API FastAPI con Prometheus Instrumentation

### ğŸ“„ `src/api/main.py`

```python
from fastapi import FastAPI
from prometheus_fastapi_instrumentator import Instrumentator # agregar este imort

# Initialize FastAPI app with metadata
app = FastAPI(
    title="House Price Prediction API",
    description=(
        "An API for predicting house prices based on various features. "
        "This application is part of the MLOps Bootcamp by School of Devops. "
        "Authored by Gourav Shah."
    ),
    version="1.0.0",
    contact={
        "name": "School of Devops",
        "url": "https://schoolofdevops.com",
        "email": "learn@schoolofdevops.com",
    },
    license_info={
        "name": "Apache 2.0",
        "url": "https://www.apache.org/licenses/LICENSE-2.0.html",
    },
)

Instrumentator().instrument(app).expose(app). # agregar esta configuracion

# dejar codigo existente que sigue como app.add_middleware(...)

```

### ğŸ“„ `src/api/requirements.txt`

```
prometheus-fastapi-instrumentator
```

---

## âš™ï¸ 2. Configuraciones previas necesarias

Para que el monitoreo funcione correctamente en Docker Compose, necesitas realizar algunos ajustes:

### ï¿½ Cambio en Streamlit App (si aplica)

**Archivo**: `streamlit_app/app.py`

**Antes:**

```python
api_endpoint = os.getenv("API_URL", "http://localhost:8000")
```

**DespuÃ©s:**

```python
api_endpoint = os.getenv("API_URL", "http://api:8000")
```

**Â¿Por quÃ©?** En Docker Compose, los contenedores se comunican usando el **nombre del servicio**, no `localhost`.

### ğŸ”„ Cambio en Dockerfile de la API

**Archivo**: `Dockerfile`

**Antes:**

```dockerfile
CMD ["uvicorn", "src.api.main:app", "--host", "0.0.0.0", "--port", "8000"]
```

**DespuÃ©s:**

```dockerfile
CMD ["uvicorn", "src.api.main:app", "--host", "0.0.0.0", "--port", "80"]
```

**Â¿Por quÃ©?** Para alinear con el mapeo de puertos en docker-compose: `8000:80` (host:contenedor).

---

## ï¿½ğŸ³ 3. DockerizaciÃ³n de los servicios

### ğŸ“„ `docker-compose.yml`

```yaml
version: "3.8"

services:
  api:
    image: pytuxi/house-price-model:v1.0.3
    ports:
      - "8000:80"

  streamlit:
    image: pytuxi/house-price-streamlit:v1.0.1
    ports:
      - "8501:8501"
    depends_on:
      - api

  prometheus:
    image: prom/prometheus:v2.52.0
    ports:
      - "9090:9090"
    volumes:
      - ./monitoring/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml

  grafana:
    image: grafana/grafana:10.2.2
    ports:
      - "3000:3000"
    depends_on:
      - prometheus
```

---

## ğŸ“Š 4. ConfiguraciÃ³n de Prometheus

### ğŸ“„ `monitoring/prometheus/prometheus.yml`

```yaml
global:
  scrape_interval: 15s

scrape_configs:
  - job_name: "fastapi"
    static_configs:
      - targets: ["api:80"] # Nombre del servicio + puerto interno
```

**âš ï¸ Importante**: Usar `api:80` (nombre del servicio + puerto interno del contenedor), no `localhost:8000`.

---

## ï¿½ ComunicaciÃ³n entre contenedores

### ğŸ“Š Diagrama de red interna:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Streamlit     â”‚â”€â”€â”€â–¶â”‚      API        â”‚â—€â”€â”€â”€â”‚   Prometheus    â”‚
â”‚ (streamlit:8501)â”‚    â”‚   (api:80)      â”‚    â”‚ (prometheus:9090â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚                       â”‚
         â–¼                       â–¼                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Red Docker Compose                          â”‚
â”‚   Puertos externos: 8501, 8000, 9090, 3000                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ğŸ¯ ComparaciÃ³n: Local vs Docker Compose

| Componente             | Desarrollo Local        | Docker Compose          |
| ---------------------- | ----------------------- | ----------------------- |
| **Streamlit â†’ API**    | `http://localhost:8000` | `http://api:8000`       |
| **Prometheus â†’ API**   | `localhost:8000`        | `api:80`                |
| **Tu navegador â†’ API** | `http://localhost:8000` | `http://localhost:8000` |
| **Puerto interno API** | `8000`                  | `80`                    |

---

## ï¿½ğŸš€ 5. Levantar los servicios

```bash
docker-compose -f deployment/docker-compose/docker-compose.yaml up -d
```

---

## ğŸ” 6. Validaciones

### ğŸ”¸ Prometheus

Navega a:

```
http://localhost:9090/targets
```

Consulta mÃ©tricas como:

```
http_requests_total
process_cpu_seconds_total
```

### ğŸ”¸ Grafana

1. Ir a: `http://localhost:3000`
2. Usuario/contraseÃ±a: `admin / admin`
3. Configurar datasource:
   - **Type**: Prometheus
   - **URL**: `http://prometheus:9090`
4. Guardar y testear

---

## ğŸ“ˆ 7. Crear un dashboard en Grafana

1. `+ Create` â†’ Dashboard â†’ Add Panel
2. En â€œQueryâ€:
   ```
   http_server_requests_total{job="fastapi"}
   ```
3. Visualiza en formato **Time Series**

---

## ğŸ§ª 8. Simular trÃ¡fico

```bash
curl http://localhost:8000/
curl http://localhost:8000/predict
```

---

## ğŸ§¼ 9. Para detener

```bash
docker-compose down
```

---

## ğŸ“Š 10. Importar y personalizar el dashboard de Grafana (ID: 15834)

Grafana proporciona un dashboard listo para usar con FastAPI:  
ğŸ‘‰ [https://grafana.com/grafana/dashboards/15834-fastapi](https://grafana.com/grafana/dashboards/15834-fastapi)

### ğŸ“¥ Pasos para importar:

1. Ir a Grafana `http://localhost:3000`
2. MenÃº lateral â†’ **+ Create â†’ Import**
3. En "Import via grafana.com", ingresa el ID: `15834`
4. Click en **Load**
5. Selecciona el datasource Prometheus configurado
6. Click en **Import**

---

## ğŸ“ˆ 11. Indicadores clave del dashboard

AquÃ­ algunos paneles Ãºtiles incluidos (y cÃ³mo actualizarlos si fuera necesario):

### ğŸ”¸ Request per second (total)

```promql
rate(http_server_requests_total{job="fastapi"}[1m])
```

> Si no ves datos, aumenta el rango a `[5m]`.

### ğŸ”¸ Request duration (latencia)

```promql
histogram_quantile(0.95, rate(http_request_duration_seconds_bucket{job="fastapi"}[5m]))
```

### ğŸ”¸ CPU Usage (seconds per second)

```promql
rate(process_cpu_seconds_total{job="fastapi"}[1m])
```

Multiplica por 100 si quieres verlo en `%` para 1 core.

### ğŸ”¸ Porcentaje de respuestas exitosas (2xx)

```promql
sum(rate(http_server_requests_total{job="fastapi", status=~"2.."}[1m]))
/
sum(rate(http_server_requests_total{job="fastapi"}[1m]))
```

### ğŸ”¸ CÃ³digos 4xx y 5xx

```promql
sum(rate(http_server_requests_total{job="fastapi", status=~"4.."}[1m]))
```

```promql
sum(rate(http_server_requests_total{job="fastapi", status=~"5.."}[1m]))
```

---

## ğŸ§ª 12. Sugerencia de trÃ¡fico para alimentar las mÃ©tricas

Usa el script `generate_traffic.py` para enviar solicitudes `GET /` y `POST /predict` automÃ¡ticamente y observar cÃ³mo se llenan los paneles en tiempo real.

---

## ğŸ”§ Troubleshooting

### âŒ Prometheus no encuentra la API

**SÃ­ntomas**: En `http://localhost:9090/targets` aparece el target como "Down"

**Soluciones**:

1. Verificar que el API estÃ© corriendo en puerto 80 interno: `docker logs <api-container>`
2. Confirmar que `prometheus.yml` use `api:80`, no `localhost:8000`
3. Verificar que todos los contenedores estÃ©n en la misma red Docker

### âŒ Streamlit no puede conectar con API

**SÃ­ntomas**: Error de conexiÃ³n en la app Streamlit

**Soluciones**:

1. Cambiar `localhost:8000` por `api:8000` en `streamlit_app/app.py`
2. Verificar que el contenedor API estÃ© levantado: `docker ps`
3. Probar conectividad: `docker exec streamlit-container curl http://api:8000/health`

### âŒ No aparecen mÃ©tricas en Grafana

**SÃ­ntomas**: Paneles vacÃ­os o sin datos

**Soluciones**:

1. Verificar que Prometheus estÃ© scrapeando: `http://localhost:9090/targets`
2. Generar trÃ¡fico hacia la API: `curl http://localhost:8000/`
3. Verificar datasource en Grafana: `http://prometheus:9090`
4. Aumentar el rango de tiempo en las queries: `[1m]` â†’ `[5m]`
