# ğŸ› ï¸ Monitoreo de FastAPI con Prometheus y Grafana

## ğŸ¯ Objetivo

Instrumentar una API en **FastAPI** para recolectar mÃ©tricas con **Prometheus** y visualizarlas en **Grafana**.

---

## ğŸ§© Estructura del entorno

```
mlops-lab/
â”œâ”€â”€ docker-compose.yml
â”œâ”€â”€ prometheus/
â”‚   â””â”€â”€ prometheus.yml
â”œâ”€â”€ app/
â”‚   â””â”€â”€ main.py
â”‚   â””â”€â”€ requirements.txt
```

---

## âœ… 1. API FastAPI con Prometheus Instrumentation

### ğŸ“„ `src/api/main.py`

```python
from fastapi import FastAPI
from prometheus_fastapi_instrumentator import Instrumentator # agregar este imort

# Initialize FastAPI app with metadata
app = FastAPI(
    title="House Price Prediction API",
    description=(
        "An API for predicting house prices based on various features. "
        "This application is part of the MLOps Bootcamp by School of Devops. "
        "Authored by Gourav Shah."
    ),
    version="1.0.0",
    contact={
        "name": "School of Devops",
        "url": "https://schoolofdevops.com",
        "email": "learn@schoolofdevops.com",
    },
    license_info={
        "name": "Apache 2.0",
        "url": "https://www.apache.org/licenses/LICENSE-2.0.html",
    },
)

Instrumentator().instrument(app).expose(app). # agregar esta configuracion

# dejar codigo existente que sigue como app.add_middleware(...)

```

### ğŸ“„ `src/api/requirements.txt`

```
prometheus-fastapi-instrumentator
```

---

## ğŸ³ 2. DockerizaciÃ³n de los servicios

### ğŸ“„ `docker-compose.yml`

```yaml
version: "3.8"

services:
  api:
    image: pytuxi/house-price-model:v1.0.3
    ports:
      - "8000:80"

  streamlit:
    image: pytuxi/house-price-streamlit:v1.0.1
    ports:
      - "8501:8501"
    depends_on:
      - api

  prometheus:
    image: prom/prometheus:v2.52.0
    ports:
      - "9090:9090"
    volumes:
      - ./monitoring/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml

  grafana:
    image: grafana/grafana:10.2.2
    ports:
      - "3000:3000"
    depends_on:
      - prometheus
```

---

## ğŸ“Š 3. ConfiguraciÃ³n de Prometheus

### ğŸ“„ `monitoring/prometheus/prometheus.yml`

```yaml
global:
  scrape_interval: 15s

scrape_configs:
  - job_name: "fastapi"
    static_configs:
      - targets: ["api:80"]
```

---

## ğŸš€ 4. Levantar los servicios

```bash
docker-compose -f deployment/docker-compose/docker-compose.yaml up -d
```

---

## ğŸ” 5. Validaciones

### ğŸ”¸ Prometheus

Navega a:

```
http://localhost:9090/targets
```

Consulta mÃ©tricas como:

```
http_requests_total
process_cpu_seconds_total
```

### ğŸ”¸ Grafana

1. Ir a: `http://localhost:3000`
2. Usuario/contraseÃ±a: `admin / admin`
3. Configurar datasource:
   - **Type**: Prometheus
   - **URL**: `http://prometheus:9090`
4. Guardar y testear

---

## ğŸ“ˆ 6. Crear un dashboard en Grafana

1. `+ Create` â†’ Dashboard â†’ Add Panel
2. En â€œQueryâ€:
   ```
   http_server_requests_total{job="fastapi"}
   ```
3. Visualiza en formato **Time Series**

---

## ğŸ§ª 7. Simular trÃ¡fico

```bash
curl http://localhost:8000/
curl http://localhost:8000/predict
```

---

## ğŸ§¼ 8. Para detener

```bash
docker-compose down
```

---

## ğŸ“Š 9. Importar y personalizar el dashboard de Grafana (ID: 15834)

Grafana proporciona un dashboard listo para usar con FastAPI:  
ğŸ‘‰ [https://grafana.com/grafana/dashboards/15834-fastapi](https://grafana.com/grafana/dashboards/15834-fastapi)

### ğŸ“¥ Pasos para importar:

1. Ir a Grafana `http://localhost:3000`
2. MenÃº lateral â†’ **+ Create â†’ Import**
3. En "Import via grafana.com", ingresa el ID: `15834`
4. Click en **Load**
5. Selecciona el datasource Prometheus configurado
6. Click en **Import**

---

## ğŸ“ˆ 10. Indicadores clave del dashboard

AquÃ­ algunos paneles Ãºtiles incluidos (y cÃ³mo actualizarlos si fuera necesario):

### ğŸ”¸ Request per second (total)

```promql
rate(http_server_requests_total{job="fastapi"}[1m])
```

> Si no ves datos, aumenta el rango a `[5m]`.

### ğŸ”¸ Request duration (latencia)

```promql
histogram_quantile(0.95, rate(http_request_duration_seconds_bucket{job="fastapi"}[5m]))
```

### ğŸ”¸ CPU Usage (seconds per second)

```promql
rate(process_cpu_seconds_total{job="fastapi"}[1m])
```

Multiplica por 100 si quieres verlo en `%` para 1 core.

### ğŸ”¸ Porcentaje de respuestas exitosas (2xx)

```promql
sum(rate(http_server_requests_total{job="fastapi", status=~"2.."}[1m]))
/
sum(rate(http_server_requests_total{job="fastapi"}[1m]))
```

### ğŸ”¸ CÃ³digos 4xx y 5xx

```promql
sum(rate(http_server_requests_total{job="fastapi", status=~"4.."}[1m]))
```

```promql
sum(rate(http_server_requests_total{job="fastapi", status=~"5.."}[1m]))
```

---

## ğŸ§ª 11. Sugerencia de trÃ¡fico para alimentar las mÃ©tricas

Usa el script `generate_traffic.py` para enviar solicitudes `GET /` y `POST /predict` automÃ¡ticamente y observar cÃ³mo se llenan los paneles en tiempo real.
