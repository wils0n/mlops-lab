# ğŸ› ï¸ Monitoreo de FastAPI con Prometheus y Grafana

## ğŸ¯ Objetivo

Instrumentar una API en **FastAPI** para recolectar mÃ©tricas con **Prometheus** y visualizarlas en **Grafana**.

---

## ğŸ§© Estructura del entorno

```
mlops-lab/
â”œâ”€â”€ deployment/
â”‚   â””â”€â”€ docker-compose.yml
â”œâ”€â”€ monitoring/
â”‚   â””â”€â”€ prometheus/
â”‚       â””â”€â”€ prometheus.yml
â”œâ”€â”€ app/
â”‚   â””â”€â”€ main.py
â”‚   â””â”€â”€ requirements.txt
```

---

## âœ… 1. API FastAPI con Prometheus Instrumentation

### ğŸ“„ `app/main.py`

```python
from fastapi import FastAPI
from prometheus_fastapi_instrumentator import Instrumentator

app = FastAPI()

Instrumentator().instrument(app).expose(app)

@app.get("/")
def root():
    return {"message": "API funcionando"}

@app.get("/predict")
def predict():
    return {"prediction": 42}
```

### ğŸ“„ `app/requirements.txt`

```
fastapi
uvicorn
prometheus-fastapi-instrumentator
```

---

## ğŸ³ 2. DockerizaciÃ³n de los servicios

### ğŸ“„ `docker-compose.yml`

```yaml
version: "3.8"

services:
  api:
    build: ./app
    ports:
      - "8000:80"

  prometheus:
    image: prom/prometheus:v2.52.0
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml

  grafana:
    image: grafana/grafana:10.2.2
    ports:
      - "3000:3000"
    depends_on:
      - prometheus
```

### ğŸ“„ `app/Dockerfile`

```dockerfile
FROM python:3.10-slim

WORKDIR /app

COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

COPY . .

CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "80"]
```

---

## ğŸ“Š 3. ConfiguraciÃ³n de Prometheus

### ğŸ“„ `prometheus/prometheus.yml`

```yaml
global:
  scrape_interval: 15s

scrape_configs:
  - job_name: "fastapi"
    static_configs:
      - targets: ["api:80"]
```

---

## ğŸš€ 4. Levantar los servicios

```bash
docker-compose up --build
```

---

## ğŸ” 5. Validaciones

### ğŸ”¸ Prometheus
Navega a:
```
http://localhost:9090/targets
```
Consulta mÃ©tricas como:
```
http_server_requests_total
```

### ğŸ”¸ Grafana

1. Ir a: `http://localhost:3000`
2. Usuario/contraseÃ±a: `admin / admin`
3. Configurar datasource:
   - **Type**: Prometheus
   - **URL**: `http://prometheus:9090`
4. Guardar y testear

---

## ğŸ“ˆ 6. Crear un dashboard en Grafana

1. `+ Create` â†’ Dashboard â†’ Add Panel
2. En â€œQueryâ€:
   ```
   http_server_requests_total{job="fastapi"}
   ```
3. Visualiza en formato **Time Series**

---

## ğŸ§ª 7. Simular trÃ¡fico

```bash
curl http://localhost:8000/
curl http://localhost:8000/predict
```

---

## ğŸ§¼ 8. Para detener

```bash
docker-compose down
```

---

## ğŸ“ Referencias

- [Prometheus FastAPI Instrumentator](https://github.com/trallard/prometheus-fastapi-instrumentator)
- [Prometheus](https://prometheus.io)
- [Grafana](https://grafana.com)