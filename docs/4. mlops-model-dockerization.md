# 🐳 Guía Completa: Dockerizar Modelo ML con FastAPI

Esta guía te muestra cómo dockerizar un modelo de machine learning y exponerlo a través de una API REST usando FastAPI.

## 📋 Tabla de Contenidos

1. [Arquitectura del Sistema](#arquitectura)
2. [Preparación del Modelo](#preparacion)
3. [Desarrollo de la API FastAPI](#fastapi)
4. [Desarrollo y Testing Local](#desarrollo-local)
5. [Dockerización](#dockerizacion)
6. [Testing y Validación](#testing)

---

## 🏗️ Arquitectura del Sistema {#arquitectura}

```
┌─────────────────────────────────────────────────────────────┐
│                    ARQUITECTURA MLOPS                      │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  📊 Datos → 🔧 Preprocessing → 🤖 Modelo → 🐳 Docker       │
│                                                             │
│  ┌─────────────┐  ┌──────────────┐  ┌─────────────────┐    │
│  │   Dataset   │  │ Preprocessor │  │   Trained Model │    │
│  │ (CSV/JSON)  │  │   (.pkl)     │  │     (.pkl)      │    │
│  └─────────────┘  └──────────────┘  └─────────────────┘    │
│                                                             │
│                    ⬇️ PACKAGING ⬇️                          │
│                                                             │
│  ┌─────────────────────────────────────────────────────────┐│
│  │                🐳 CONTAINER                            ││
│  │                                                        ││
│  │  ┌─────────────┐    ┌─────────────┐    ┌──────────┐   ││
│  │  │   FastAPI   │    │    Model    │    │   Data   │   ││
│  │  │ (main.py)   │ ←→ │ (inference) │ ←→ │ (models) │   ││
│  │  └─────────────┘    └─────────────┘    └──────────┘   ││
│  │                                                        ││
│  │  Port 8000 → 🌐 REST API Endpoints                    ││
│  └─────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────┘
```

---

## 🎯 Preparación del Modelo {#preparacion}

### **1. Estructura de Proyecto**

```
mlops-lab/
├── 📁 src/
│   └── 📁 api/
│       ├── main.py           # FastAPI app
│       ├── inference.py      # Lógica de predicción
│       ├── schemas.py        # Modelos Pydantic
│       ├── requirements.txt  # Dependencias API
│       └── __init__.py
├── 📁 models/
│   └── 📁 trained/
│       ├── house_price_model.pkl      # Modelo entrenado
│       └── preprocessor.pkl           # Pipeline de preprocessing
├── 📁 data/
│   └── 📁 processed/
│       └── featured_house_data.csv    # Datos procesados
├── Dockerfile                # Configuración del contenedor
└── requirements.txt          # Dependencias del proyecto
```

### **2. Archivos del Modelo**

Los archivos esenciales para el modelo:

```python
# Generados durante el entrenamiento:
models/trained/house_price_model.pkl      # Modelo ML (RandomForest, etc.)
models/trained/preprocessor.pkl           # Pipeline de transformación
```

---

## 🚀 Desarrollo de la API FastAPI {#fastapi}

### **1. Esquemas de Datos (`src/api/schemas.py`)**

Define los modelos de datos (esquemas) usando Pydantic para validar y documentar las solicitudes y respuestas de la API, como `HousePredictionRequest` y `PredictionResponse`.

### **2. Lógica de Inferencia (`src/api/inference.py`)**

Contiene la lógica de inferencia del modelo: carga el modelo y el preprocesador entrenados, transforma los datos de entrada y realiza la predicción de precios de casas.

### **3. Aplicación FastAPI (`src/api/main.py`)**

Es el archivo principal de la aplicación FastAPI. Configura la app, los endpoints (`/predict`, `/batch-predict`, `/health`), el middleware CORS y expone la API para servir las predicciones.

### **4. Dependencias (`src/api/requirements.txt`)**

```txt
fastapi==0.116.1
uvicorn==0.35.0
pandas==2.3.1
joblib==1.5.1
scikit-learn==1.7.1
numpy==2.3.1
xgboost==2.1.4
pyyaml==6.0.2
```

---

## �️ Desarrollo y Testing Local {#desarrollo-local}

**⚠️ IMPORTANTE**: Antes de dockerizar, siempre prueba tu API localmente para asegurar que todo funciona correctamente.

### **1. Preparar Entorno Local**

```bash
# 1. Asegurar estructura de proyecto
pwd  # Debe estar en mlops-lab/

# 2. Verificar que los modelos están entrenados
ls -la models/trained/
# Debe mostrar:
# house_price_model.pkl
# preprocessor.pkl

# 3. Activar entorno virtual
conda activate mlops-fisi
# o
source venv/bin/activate
```

### **2. Instalar Dependencias**

```bash
# Instalar dependencias específicas de la API
pip install -r src/api/requirements.txt

# O instalar manualmente las dependencias principales
pip install fastapi==0.116.1 uvicorn==0.35.0 pydantic==2.8.2 pandas==2.2.3 scikit-learn==1.7.1 joblib==1.4.2
```

### **3. Ejecutar FastAPI en Modo Desarrollo**

```bash
python -m uvicorn src.api.main:app --host 0.0.0.0 --port 8000 --reload
```

**Deberías ver output similar a:**

```
INFO:     Will watch for changes in these directories: ['/path/to/mlops-lab']
INFO:     Uvicorn running on http://0.0.0.0:8000 (Press CTRL+C to quit)
INFO:     Started reloader process [12345]
INFO:     Started server process [12346]
INFO:     Waiting for application startup.
INFO:     Application startup complete.
✅ Model loaded: RandomForestRegressor
✅ Preprocessor loaded successfully
```

### **5. Testing Completo Local**

#### **Health Check**

```bash
# Verificar que la API está funcionando
curl http://localhost:8000/health
```

**Respuesta esperada:**

```json
{ "status": "healthy", "model_loaded": true }
```

#### **Documentación Interactiva**

```bash
# Abrir Swagger UI en tu navegador
open http://localhost:8000/docs  # macOS
# o navega manualmente a http://localhost:8000/docs
```

#### **Test de Predicción Individual**

```bash
# Test con curl
curl -X POST "http://localhost:8000/predict" \
-H "Content-Type: application/json" \
-d '{
  "sqft": 1527,
  "bedrooms": 2,
  "bathrooms": 1.5,
  "location": "Suburb",
  "year_built": 1956,
  "condition": "Good",
  "price_per_sqft": 320
}'
```

**Respuesta esperada:**

```json
{
  "predicted_price": 566959.08,
  "confidence_interval": [510263.17, 623654.99],
  "features_importance": {},
  "prediction_time": "2025-08-01T18:25:24.244040"
}
```

### **6. Logs y Monitoreo Local**

```bash
# Los logs aparecen directamente en la terminal donde ejecutas uvicorn
# Para logs más detallados:
python -m uvicorn src.api.main:app --host 0.0.0.0 --port 8000 --reload --log-level debug

# Monitorear requests en tiempo real:
# Los requests aparecen automáticamente en la terminal
```

### **✅ Checklist Pre-Dockerización**

Antes de proceder con Docker, asegúrate de que todos estos items están ✅:

- [ ] **API funcionando**: `uvicorn` inicia sin errores
- [ ] **Health check**: `curl http://localhost:8000/health` retorna 200
- [ ] **Predicción simple**: Test de predicción individual funciona
- [ ] **Predicción batch**: Test de predicción en lotes funciona
- [ ] **Validación**: Errores de validación se manejan correctamente
- [ ] **Documentación**: `http://localhost:8000/docs` se carga correctamente

**🎯 Una vez que todos los checks estén ✅, procede con la dockerización sabiendo que tu API funciona perfectamente.**

---

## �🐳 Dockerización {#dockerizacion}

### **1. Dockerfile**

```dockerfile
# Use Python 3.11 slim image
FROM python:3.11-slim

# Set working directory
WORKDIR /app

# Install system dependencies
RUN apt-get update && apt-get install -y \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Copy requirements
COPY src/api/requirements.txt ./src/api/

# Install Python dependencies
RUN pip install --no-cache-dir -r src/api/requirements.txt

# ✅ Copy complete project structure
COPY src/ ./src/
COPY models/ ./models/

# Create __init__.py files to make packages work
RUN touch src/__init__.py
RUN touch src/api/__init__.py

# Create a non-root user for security
RUN useradd -m -u 1000 appuser && chown -R appuser:appuser /app
USER appuser

# Expose port
EXPOSE 8000

# Health check
HEALTHCHECK --interval=30s --timeout=30s --start-period=5s --retries=3 \
    CMD curl -f http://localhost:8000/health || exit 1

# ✅ Run with same command as local
CMD ["uvicorn", "src.api.main:app", "--host", "0.0.0.0", "--port", "8000"]
```

### **2. Construir Imagen con Versionado**

```bash
# Construir la imagen Docker con versión específica
docker build -t house-price-model:v1.0.0 .
docker build -t house-price-model:latest .

# Verificar la imagen
docker images | grep house-price-model
```

### **3. Ejecutar Contenedor**

```bash
# Ejecutar en modo detached con versión específica
docker run -d -p 8000:8000 --name house-price-api house-price-model:v1.0.0

# Verificar que está corriendo
docker ps

# Ver logs
docker logs house-price-api
```

---

## 🧪 Testing y Validación {#testing}

### **1. Health Check**

```bash
# Verificar que la API está funcionando
curl http://localhost:8000/health

# Respuesta esperada:
# {"status": "healthy", "model_loaded": true}
```

### **2. Documentación Automática**

Visita en tu navegador:

- **Swagger UI**: http://localhost:8000/docs
- **ReDoc**: http://localhost:8000/redoc

### **3. Test de Predicción Individual**

```bash
curl -X POST "http://localhost:8000/predict" \
-H "Content-Type: application/json" \
-d '{
  "sqft": 1527,
  "bedrooms": 2,
  "bathrooms": 1.5,
  "location": "Suburb",
  "year_built": 1956,
  "condition": "Good",
  "price_per_sqft": 320
}'
```

**Respuesta esperada:**

```json
{
  "predicted_price": 566959.08,
  "confidence_interval": [510263.17, 623654.99],
  "features_importance": {},
  "prediction_time": "2025-07-24T18:25:24.244040"
}
```

### **4. Test de Predicción en Lotes**

```bash
curl -X POST "http://localhost:8000/batch-predict" \
-H "Content-Type: application/json" \
-d '[
  {
    "sqft": 1527,
    "bedrooms": 2,
    "bathrooms": 1.5,
    "location": "Suburb",
    "year_built": 1956,
    "condition": "Good",
    "price_per_sqft": 320
  },
  {
    "sqft": 2100,
    "bedrooms": 3,
    "bathrooms": 2.0,
    "location": "Urban",
    "year_built": 2005,
    "condition": "Excellent",
    "price_per_sqft": 280
  }
]'
```

---

## 📦 Publicación en Docker Hub

### **1. Preparación para Publicar**

```bash
# 1. Verificar que la imagen funciona localmente
docker run -d -p 8000:8000 --name house-price-api house-price-model:v1.0.0
curl http://localhost:8000/health
docker stop house-price-api && docker rm house-price-api
```

### **2. Login y Tag de Imagen**

```bash
# Login a Docker Hub
docker login
# Introduce tu username y password de Docker Hub

# Tag de la imagen con tu usuario de Docker Hub
docker tag house-price-model:v1.0.0 tu-usuario/house-price-model:v1.0.0
docker tag house-price-model:latest tu-usuario/house-price-model:latest

# Ejemplo real:
# docker tag house-price-model:v1.0.0 pytuxi/house-price-model:v1.0.0
# docker tag house-price-model:latest pytuxi/house-price-model:latest
```

### **3. Publicar en Docker Hub**

```bash
# Push de la versión específica (recomendado)
docker push tu-usuario/house-price-model:v1.0.0

# Push de latest (opcional)
docker push tu-usuario/house-price-model:latest

# Verificar en Docker Hub
echo "✅ Imagen disponible en: https://hub.docker.com/r/tu-usuario/house-price-model"
```

---

## 📥 Descarga y Uso de la Imagen

### **1. Descargar desde Docker Hub**

```bash
# Descargar versión específica (recomendado)
docker pull tu-usuario/house-price-model:v1.0.0

# O descargar latest (puede tener cambios no deseados)
docker pull tu-usuario/house-price-model:latest
```

### **2. Ejecutar Imagen Descargada**

```bash
# Ejecutar la versión específica descargada
docker run -d -p 8000:8000 --name house-price-api tu-usuario/house-price-model:v1.0.0

# Para Apple Silicon (ARM64), especificar plataforma si es necesario
docker run -d -p 8000:8000 --platform linux/arm64 --name house-price-api tu-usuario/house-price-model:v1.0.0

# Verificar que está corriendo
docker ps
```

### **3. Verificación Post-Descarga**

```bash
# Health check
curl http://localhost:8000/health

# Test de predicción
curl -X POST "http://localhost:8000/predict" \
-H "Content-Type: application/json" \
-d '{
  "sqft": 1527,
  "bedrooms": 2,
  "bathrooms": 1.5,
  "location": "Suburb",
  "year_built": 1956,
  "condition": "Good",
  "price_per_sqft": 320
}'

# Abrir documentación en navegador
open http://localhost:8000/docs
```

---

## 📝 Comandos de Referencia Rápida

```bash
# 🖥️ DESARROLLO LOCAL (PRIMERO)
# Verificar modelos
python test_model_loading.py

# Ejecutar API local
python -m uvicorn src.api.main:app --host 0.0.0.0 --port 8000 --reload

# Testing local
curl http://localhost:8000/health
python test_api_local.py

# 🐳 DESARROLLO DOCKER (DESPUÉS)
# Build & Run (Local)
docker build -t house-price-model:v1.0.0 .
docker run -d -p 8000:8000 --name api house-price-model:v1.0.0

# 📦 PUBLICACIÓN
# Publicar en Docker Hub
docker tag house-price-model:v1.0.0 tu-usuario/house-price-model:v1.0.0
docker push tu-usuario/house-price-model:v1.0.0

# 📥 DESCARGA Y USO
# Descargar y usar desde Docker Hub
docker pull tu-usuario/house-price-model:v1.0.0
docker run -d -p 8000:8000 --name api tu-usuario/house-price-model:v1.0.0

# 🧪 TESTING (Ambos)
curl http://localhost:8000/health
curl -X POST http://localhost:8000/predict -H "Content-Type: application/json" -d @test_data.json

# 📊 LOGS & DEBUG
# Local: Logs aparecen en terminal
# Docker: docker logs api
docker exec -it api /bin/bash

# 🧹 CLEANUP
# Local: Ctrl+C
# Docker: docker stop api && docker rm api
```

---

## 🏷️ Gestión de Versiones

### **Estrategia de Versionado**

```bash
# Versiones semánticas
docker build -t house-price-model:v1.0.0 .  # Release inicial
docker build -t house-price-model:v1.0.1 .  # Bug fix
docker build -t house-price-model:v1.1.0 .  # Nueva funcionalidad
docker build -t house-price-model:v2.0.0 .  # Cambio mayor

# Tags por ambiente
docker tag house-price-model:v1.0.0 tu-usuario/house-price-model:dev
docker tag house-price-model:v1.0.0 tu-usuario/house-price-model:staging
docker tag house-price-model:v1.0.0 tu-usuario/house-price-model:prod

# Tag por fecha
docker tag house-price-model:v1.0.0 tu-usuario/house-price-model:2025-07-24
```

### **Mejores Prácticas**

1. **✅ Siempre usar versiones específicas** en producción
2. **✅ Testear localmente** antes de publicar
3. **✅ Usar tags semánticos** (v1.0.0, v1.1.0, etc.)
4. **✅ Mantener latest** actualizado pero no usarlo en producción
5. **✅ Documentar cambios** entre versiones

### **Ejemplo Real de Uso**

```bash
# Construir nueva versión
docker build -t house-price-model:v1.0.1 .

# Test local
docker run -d -p 8000:8000 --name test house-price-model:v1.0.1
curl http://localhost:8000/health
docker stop test && docker rm test

# Publicar
docker tag house-price-model:v1.0.1 pytuxi/house-price-model:v1.0.1
docker push pytuxi/house-price-model:v1.0.1

# Uso en otros servidores
docker pull pytuxi/house-price-model:v1.0.1
docker run -d -p 8000:8000 pytuxi/house-price-model:v1.0.1
```

---

## 🎯 Próximos Pasos

**¡Flujo Recomendado de Desarrollo:**

1. ✅ **Desarrollo Local**: Siempre prueba tu API localmente primero
2. ✅ **Testing Completo**: Ejecuta todos los tests antes de dockerizar
3. ✅ **Dockerización**: Solo cuando todo funciona localmente
4. ✅ **Publicación**: Publica a Docker Hub para compartir

**Siguientes pasos en tu pipeline MLOps:**

1. **CI/CD Pipeline**: Automatizar builds y despliegues

---

## 📚 Recursos Adicionales

- [FastAPI Documentation](https://fastapi.tiangolo.com/)
- [Docker Best Practices](https://docs.docker.com/develop/dev-best-practices/)
- [MLOps with Docker](https://neptune.ai/blog/mlops-with-docker)
- [Prometheus Monitoring](https://prometheus.io/docs/guides/go-application/)

---

**🏆 ¡Felicidades! Has dockerizado exitosamente tu modelo ML con FastAPI. Tu modelo ahora está listo para producción, es escalable y fácil de desplegar en cualquier entorno.**
